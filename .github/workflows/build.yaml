name: Build
on:
  workflow_dispatch:
    inputs:
      charts_ref:
        description: 'Target rancher/charts branch against which a PR will be opened'
        required: true
        default: "dev-v2.9"
        type: choice
        options:
          - "dev-v2.7"
          - "dev-v2.8"
          - "dev-v2.9"
      previous_operator_version:
        description: 'Previous operator version (e.g. 1.1.0-rc2)'
        required: true
        default: ""
      new_operator_version:
        description: 'New operator version'
        required: true
        default: ""
      previous_chart_version:
        description: 'Previous Rancher chart version (e.g. 101.1.0)'
        required: true
        default: ""
      new_chart_version:
        description: 'New Rancher chart version'
        required: true
        default: ""
      should_replace:
        description: 'Should the old operator version be replaced/removed? (e.g. true in case of release candidate bumps)'
        required: true
        default: true
        type: boolean

env:
  OPERATOR: gke-operator
  
jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Set env variables
        run: |
          echo "TIMESTAMP=$(date +'%s')" >> $GITHUB_ENV
          CHARTS_REF=${{ github.event.inputs.charts_ref }}
          echo "VERSION=${CHARTS_REF: -4}" >> $GITHUB_ENV
      - env:
          GITHUB_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          git checkout -b branch-$TIMESTAMP
          date > generated.txt
          git config user.name "yiannistr"
          git config user.email "yiannistr@users.noreply.github.com"
          git add ./generated.txt
          git commit -m "generated"
          git remote add bot https://${GITHUB_TOKEN}@github.com/yiannistr/test-gh-action.git
          git push bot HEAD:${{ env.OPERATOR }}-$VERSION-$TIMESTAMP
      - name: Create PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{secrets.BOT_TOKEN}}
          script: |
            github.pulls.create({
              owner: 'yiannistri',
              repo: 'test-gh-action',
              title: '[${{ github.event.inputs.charts_ref }}] rancher-${{ env.OPERATOR }} ${{ github.event.inputs.new_chart_version }}+up${{ github.event.inputs.new_operator_version }} update',
              head: 'yiannistr/test-gh-action:${{ env.OPERATOR }}-${{ env.VERSION }}-${{ env.TIMESTAMP }}',
              base: 'main',
              body: 'Update ${{ env.OPERATOR }} to v${{github.event.inputs.new_operator_version}}\n\nChangelog: https://github.com/rancher/${{ env.OPERATOR }}/releases/tag/v${{github.event.inputs.new_operator_version}}\n\n'
            })
